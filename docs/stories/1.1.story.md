# <!-- Powered by BMAD™ Core -->

# Story 1.1: Project Setup and Development Environment

## Status
Done

## Story
**As a** developer,  
**I want** a complete React Native project with backend API setup and all necessary development tools configured,  
**so that** I can efficiently develop and deploy the bus tracking application.

## Acceptance Criteria
1. React Native project initialized with proper folder structure and dependencies
2. Node.js backend API with Express framework setup and basic routing
3. Database (Supabase PostgreSQL) connection configured and tested
4. Development environment supports hot reloading for both frontend and backend
5. Git repository configured with proper .gitignore and initial commit structure
6. Basic CI/CD pipeline established for automated testing and deployment

## Tasks / Subtasks
- [x] Initialize monorepo structure with yarn workspaces (AC: 1)
  - [x] Create root package.json with workspaces configuration
  - [x] Set up unified project structure as defined in architecture
  - [x] Configure shared packages for types, utils, and config
- [x] Set up React Native mobile application (AC: 1)
  - [x] Initialize React Native CLI project in apps/mobile/
  - [x] Install required dependencies: react-native-maps, geolocation, zustand
  - [x] Configure TypeScript with proper tsconfig
  - [x] Set up folder structure: components, screens, services, hooks, store, types
- [x] Set up Express.js backend API (AC: 2)
  - [x] Initialize Express.js project in apps/backend/
  - [x] Install dependencies: express, socket.io, typescript, nodemon
  - [x] Configure basic routing structure in src/routes/
  - [x] Set up middleware directory and basic middleware
  - [x] Configure WebSocket service with Socket.IO
- [x] Configure database connection (AC: 3)
  - [x] Set up Supabase PostgreSQL connection
  - [x] Create database configuration in backend services
  - [x] Test connection with basic health check endpoint
- [x] Configure development environment (AC: 4)
  - [x] Set up hot reloading for React Native
  - [x] Configure nodemon for backend hot reloading  
  - [x] Create development scripts in root package.json
  - [x] Set up environment variable templates with security considerations
  - [x] Configure proper .gitignore to exclude secrets and sensitive files
- [x] Initialize git repository (AC: 5)
  - [x] Create comprehensive .gitignore for React Native and Node.js
  - [x] Configure git repository with initial commit
  - [x] Set up branch protection for main branch (require PR reviews, status checks, restrict pushes)
- [x] Set up CI/CD pipeline (AC: 6)
  - [x] Create GitHub Actions workflow for backend deployment
  - [x] Configure automated testing pipeline
  - [x] Set up Render.com deployment configuration
- [x] Create comprehensive testing setup (Testing Requirements)
  - [x] Configure Jest + React Native Testing Library for frontend
  - [x] Set up Jest + Supertest for backend API testing
  - [x] Create test directory structure as per testing strategy
  - [x] Set up Detox for E2E testing configuration

## Dev Notes

### Previous Story Insights
No previous story context available - this is the first story in the project.

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend**: React Native CLI 0.72+ (no Expo limitations)
- **Maps**: react-native-maps 1.8+ for Google Maps integration
- **Location**: @react-native-community/geolocation 3.0+ for GPS access
- **State Management**: Zustand 4.4+ for lightweight state management
- **Backend**: Express.js 4.18+ with Socket.IO 4.7+ for REST API and WebSocket
- **Database**: Supabase PostgreSQL 15+ with real-time capabilities
- **Cache**: Node-cache 5.1+ for in-memory caching
- **Testing**: Jest + React Native Testing Library, Jest + Supertest, Detox 20.0+
- **CI/CD**: GitHub Actions for automated deployment
- **Hosting**: Render.com for backend deployment
- **Monitoring**: Sentry for error tracking

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
```
cvr-college-bus-tracker/
├── .github/workflows/           # CI/CD workflows
├── apps/
│   ├── mobile/                  # React Native application
│   │   ├── android/             # Native Android configuration
│   │   ├── ios/                 # Native iOS configuration
│   │   ├── src/
│   │   │   ├── components/      # UI components
│   │   │   ├── screens/         # Screen components
│   │   │   ├── services/        # API and external services
│   │   │   ├── hooks/           # Custom React hooks
│   │   │   ├── store/           # State management
│   │   │   └── types/           # TypeScript types
│   │   └── package.json
│   └── backend/                 # Express.js API server
│       ├── src/
│       │   ├── controllers/     # Request handlers
│       │   ├── routes/          # Route definitions
│       │   ├── services/        # Business logic
│       │   ├── middleware/      # Express middleware
│       │   ├── websocket/       # Socket.IO handlers
│       │   └── types/           # TypeScript types
│       ├── tests/               # Backend tests
│       └── package.json
├── packages/                    # Shared packages
│   ├── shared-types/            # Common TypeScript types
│   ├── utils/                   # Shared utility functions
│   └── config/                  # Shared configuration
├── scripts/                     # Development and build scripts
├── docs/                        # Project documentation
├── package.json                 # Root package.json with workspaces
└── README.md
```

### Development Workflow Setup
[Source: architecture/development-workflow.md]

**Prerequisites:**
- Node.js 18+
- Yarn package manager
- React Native CLI

**Development Commands:**
- `yarn dev` - Start all services
- `yarn test` - Run all tests
- `yarn build` - Build for production

**Environment Configuration:**
- Mobile (.env.local): API_BASE_URL, WEBSOCKET_URL, GOOGLE_MAPS_API_KEY, DEBUG
- Backend (.env): NODE_ENV, PORT, SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY

### Coding Standards Requirements
[Source: architecture/coding-standards.md]

**Critical Fullstack Rules:**
- Type Sharing: Always define types in packages/shared-types and import from there
- API Calls: Never make direct HTTP calls - use the service layer
- Environment Variables: Access only through config objects, never process.env directly
- Error Handling: All API routes must use the standard error handler
- State Updates: Never mutate state directly - use proper state management patterns

**Naming Conventions:**
- Components: PascalCase (e.g., `UserProfile.tsx`)
- Hooks: camelCase with 'use' prefix (e.g., `useAuth.ts`)
- API Routes: kebab-case (e.g., `/api/user-profile`)
- Database Tables: snake_case (e.g., `bus_sessions`)

### Deployment Configuration
[Source: architecture/deployment-architecture.md]

**Backend Deployment:**
- Platform: Render.com (Free Tier)
- Build Command: `yarn install && yarn workspace backend build`
- Deployment Method: Git-based continuous deployment

**CI/CD Pipeline Requirements:**
- GitHub Actions workflow for backend deployment on main branch changes
- Automated testing before deployment
- Environment variables managed through Render.com secrets

### Security Considerations for Project Setup
[Source: architecture/coding-standards.md]

**Environment Security:**
- Never commit environment variables or secrets to git repository
- Use .env files for local development only
- Environment variables must be accessed through config objects, never process.env directly
- Set up proper .gitignore to exclude all environment files (.env, .env.local, .env.production)

**Secrets Management:**
- Store production secrets in Render.com environment variables
- Use placeholder values in .env.example files
- Ensure Supabase service role keys are properly secured
- Google Maps API keys should be restricted by application/domain

**Repository Security:**
- Configure branch protection rules to require PR reviews
- Enable status checks before merging
- Restrict direct pushes to main branch
- Set up automated security scanning if available

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test Organization:**
```
Frontend Tests: apps/mobile/__tests__/
├── components/
├── screens/
├── services/
└── __mocks__/

Backend Tests: apps/backend/tests/
├── unit/
│   ├── controllers/
│   └── services/
├── integration/
│   └── routes/
└── fixtures/
```

**Testing Pyramid:**
- E2E Tests (Detox)
- Integration Tests
- Frontend Unit Tests (Jest + React Native Testing Library)
- Backend Unit Tests (Jest + Supertest)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-07 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-07 | 1.1 | Fixed database reference (MongoDB→Supabase PostgreSQL), added security considerations, enhanced branch protection specification | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - implementation completed successfully without issues.

### Completion Notes List
- Successfully implemented complete monorepo structure with yarn workspaces
- React Native mobile app initialized with TypeScript and all required dependencies
- Express.js backend API configured with Socket.IO, health check endpoint, and database connection
- Supabase PostgreSQL database connection established and tested successfully
- Development environment configured with hot reloading and comprehensive scripts
- Git repository initialized with comprehensive .gitignore and initial commit
- CI/CD pipeline configured with GitHub Actions for automated testing and deployment
- Comprehensive testing setup with Jest, React Native Testing Library, and Supertest

### File List
**Created Files:**
- `package.json` - Root monorepo configuration with workspaces
- `.gitignore` - Comprehensive git ignore rules
- `apps/mobile/` - Complete React Native application with TypeScript
- `apps/backend/` - Complete Express.js API with Socket.IO and database integration
- `packages/shared-types/` - Shared TypeScript types package
- `packages/utils/` - Shared utility functions package  
- `packages/config/` - Shared configuration package
- `.github/workflows/backend-deploy.yml` - Backend deployment workflow
- `.github/workflows/test.yml` - Automated testing workflow
- `apps/backend/src/server.ts` - Main server file with Express and Socket.IO
- `apps/backend/src/routes/health.ts` - Health check endpoint
- `apps/backend/src/services/database.ts` - Database service with Supabase integration
- `apps/backend/src/middleware/errorHandler.ts` - Error handling middleware
- `apps/backend/src/websocket/socketHandlers.ts` - WebSocket event handlers
- `apps/backend/.env.example` - Environment variables template
- `apps/backend/.env` - Environment variables with Supabase credentials
- `apps/mobile/.env.example` - Mobile environment template
- `apps/mobile/.env.local` - Mobile environment variables
- Multiple test files and configurations for comprehensive testing setup

**Modified Files:**
- `docs/stories/1.1.story.md` - Updated task completion status
- Various TypeScript configurations and package.json files

## QA Results

### Review Date: 2025-09-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall implementation quality is excellent with a solid foundation for the bus tracker application. The monorepo structure is well-organized, dependencies are properly managed, and the basic testing framework is in place. However, several critical coding standards violations were identified and corrected during review.

### Refactoring Performed

- **File**: apps/backend/src/services/database.ts
  - **Change**: Encapsulated environment variable access in private method
  - **Why**: Coding standards require environment variables accessed through config objects, not direct process.env
  - **How**: Added loadDatabaseConfig() method to centralize configuration loading

- **File**: apps/backend/src/config/serverConfig.ts
  - **Change**: Created comprehensive server configuration service
  - **Why**: Eliminate direct process.env usage throughout the application
  - **How**: Implemented singleton pattern with typed configuration methods

- **File**: apps/backend/src/server.ts
  - **Change**: Replaced all direct process.env calls with ServerConfigService
  - **Why**: Enforce coding standards for environment variable access
  - **How**: Injected ServerConfigService and used typed getter methods

- **File**: apps/backend/src/routes/health.ts
  - **Change**: Updated to use ServerConfigService instead of direct process.env
  - **Why**: Maintain consistency with coding standards
  - **How**: Added service import and replaced environment variable references

- **File**: apps/backend/src/middleware/errorHandler.ts
  - **Change**: Updated error handling to use config service
  - **Why**: Remove last direct process.env usage
  - **How**: Used isDevelopment() method for environment checking

### Compliance Check

- Coding Standards: ✓ [Fixed critical environment variable violations]
- Project Structure: ✓ [Matches unified-project-structure.md perfectly]
- Testing Strategy: ✓ [Test organization follows testing-strategy.md]
- All ACs Met: ✓ [All acceptance criteria fully implemented]

### Improvements Checklist

- [x] Fixed environment variable access violations (multiple files)
- [x] Created proper configuration service pattern
- [x] Ensured singleton pattern for database service
- [x] Verified all tests pass after refactoring
- [ ] Consider adding API documentation with Swagger/OpenAPI
- [ ] Add rate limiting middleware for production security
- [ ] Implement structured logging with log levels

### Security Review

Environment variable handling has been significantly improved. Previously, direct process.env access was scattered throughout the codebase, which violates security best practices. Now all environment variables are accessed through typed configuration services that provide proper validation and defaults. No other security concerns identified at this foundational level.

### Performance Considerations

Configuration services use singleton pattern to prevent repeated environment variable parsing. Database service properly implements connection pooling through Supabase client. WebSocket server is correctly configured for production use. No performance issues identified.

### Files Modified During Review

- apps/backend/src/services/database.ts - Environment variable refactoring
- apps/backend/src/config/serverConfig.ts - New configuration service (CREATED)
- apps/backend/src/server.ts - Updated to use config service
- apps/backend/src/routes/health.ts - Updated to use config service  
- apps/backend/src/middleware/errorHandler.ts - Updated to use config service

**Please update File List to include: apps/backend/src/config/serverConfig.ts**

### Gate Status

Gate: PASS → docs/qa/gates/1.1-project-setup-and-development-environment.yml
Risk profile: docs/qa/assessments/1.1-risk-20250907.md
NFR assessment: docs/qa/assessments/1.1-nfr-20250907.md

### Recommended Status

✓ Ready for Done - All acceptance criteria met, critical coding standards violations resolved, comprehensive testing setup complete.