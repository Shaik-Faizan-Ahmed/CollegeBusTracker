# <!-- Powered by BMAD™ Core -->

# Story 2.1: Bus Number Input and Validation

## Status
Done

## Story
**As a** student,  
**I want** to enter a bus number when tracking or becoming a tracker,  
**so that** I can specify which bus I'm interested in or currently riding.

## Acceptance Criteria
1. Bus number input screen with numeric keypad optimization for mobile
2. Input validation ensures bus numbers match expected format/range
3. Clear error messaging for invalid bus numbers
4. Input field supports common bus number formats used at CVR College
5. Form submission triggers appropriate flow (tracking vs becoming tracker)
6. Recent bus numbers are remembered for quick selection

## Tasks / Subtasks
- [x] Create BusNumberInput component with numeric keypad (AC: 1)
  - [x] Implement TextInput with keyboardType="default" for alphanumeric support
  - [x] Add component styling with proper touch targets (48pt minimum)
  - [x] Include bus number label and input field placeholder
  - [x] Test component renders correctly on Android and iOS
- [x] Implement bus number validation logic (AC: 2, 4)
  - [x] Create validation function for CVR College bus number formats
  - [x] Support numeric bus numbers (1-50) and alphanumeric (A1-A20, B1-B20, C1-C10)
  - [x] Validate bus number range with proper error messages
  - [x] Add input sanitization to remove whitespace and normalize case
- [x] Create error messaging system (AC: 3)
  - [x] Display validation errors below input field with red styling
  - [x] Show specific error messages for different validation failures
  - [x] Clear error messages when user starts typing
  - [x] Test error messages with screen readers for accessibility
- [x] Implement recent bus numbers storage (AC: 6)
  - [x] Use AsyncStorage to persist recent bus numbers list
  - [x] Show recent selections as quick-tap buttons below input
  - [x] Limit to 5 most recent bus numbers
  - [x] Add clear recent history option for privacy
- [x] Integrate form submission with navigation (AC: 5)
  - [x] Pass validated bus number to next screen (TrackBusScreen or BecomeTrackerScreen)
  - [x] Implement proper navigation with bus number parameter
  - [x] Handle form submission with loading state
  - [x] Test navigation flow from both "Track Bus" and "Become Tracker" paths
- [x] Write comprehensive unit tests for all components and services
  - [x] Test validation function with valid and invalid inputs (19 test cases)
  - [x] Test AsyncStorage operations for recent numbers (16 test cases)
  - [x] Test component rendering and user interactions (24 test cases)
  - [x] Verify error handling and loading states (10 test cases)

## Dev Notes

### Previous Story Insights
From Story 1.5 completion:
- React Native app foundation established with proper navigation structure
- Location services integrated and working on both Android and iOS platforms
- Development environment supports hot reloading for efficient testing
- TypeScript configuration established with shared types support
- Testing infrastructure ready with Jest + React Native Testing Library

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **React Native CLI 0.72+**: Full native access for keyboard optimization and AsyncStorage
- **AsyncStorage**: For persisting recent bus numbers locally on device
- **React Navigation**: Already established for screen navigation between input and tracking screens
- **Jest + React Native Testing Library**: For component testing and validation logic testing
- **TypeScript**: For type-safe validation functions and component interfaces

### Project Structure Requirements  
[Source: architecture/unified-project-structure.md]
File locations for bus number input implementation:
```
apps/mobile/src/
├── components/
│   ├── common/
│   │   ├── Input/                    # Generic input component base
│   │   └── Button/                   # Quick selection buttons
│   └── tracking/
│       └── BusSelector/              # Bus number input with validation
│           ├── BusNumberInput.tsx    # Main input component
│           ├── RecentBusList.tsx     # Recent selections display
│           └── ValidationError.tsx   # Error message component
├── screens/
│   ├── TrackBusScreen/              # Consumer flow destination
│   └── BecomeTrackerScreen/         # Tracker flow destination
├── services/
│   ├── storage.ts                   # AsyncStorage operations
│   └── validation.ts               # Bus number validation logic
└── types/
    └── bus.ts                       # Bus number related type definitions
```

### Component Architecture Requirements
[Source: architecture/frontend-architecture.md]
State management integration with Zustand:
```typescript
interface AppState {
  selectedBus: string | null;
  recentBusNumbers: string[];
  
  setSelectedBus: (busNumber: string) => void;
  addRecentBusNumber: (busNumber: string) => void;
  clearRecentBusNumbers: () => void;
}
```

### Data Models Requirements
[Source: architecture/data-models.md]
Bus number validation must align with BusSession data model:
- **busNumber: string** - Bus identifier supporting both numeric ("12", "15") and alphanumeric ("A1", "B2") formats
- Input validation must ensure compatibility with backend API expectations
- Bus numbers used in this component will be passed to `/api/buses/{busNumber}` endpoints

### Core Workflow Integration
[Source: architecture/core-workflows.md]
This component serves as the entry point for both major workflows:
1. **Become Tracker Flow**: Student enters bus number → BecomeTrackerScreen receives validated bus number
2. **Track Bus Flow**: Student enters bus number → TrackBusScreen receives validated bus number for API lookup

### CVR College Bus Number Format Specifications
Based on the CVR College transportation system requirements:
- **Numeric Format**: 1-50 (standard route buses)
- **Alphanumeric Format**: A1-A20 (Express routes), B1-B20 (Local routes), C1-C10 (Special routes)
- **Validation Rules**:
  - Numeric: 1-50 only, no leading zeros
  - Alphanumeric: Letter (A-C) followed by number (1-20 for A/B routes, 1-10 for C routes)
  - Case insensitive input, normalize to uppercase for storage

### Storage Requirements
[Source: architecture/coding-standards.md]
AsyncStorage usage standards:
- **Key Naming**: Use consistent prefixes (`cvr_bus_tracker_recent_buses`)
- **Data Structure**: JSON array of strings for recent bus numbers
- **Error Handling**: Graceful fallback when AsyncStorage unavailable
- **Privacy**: Clear storage option for user privacy

### Navigation Integration
Component must integrate with existing navigation structure:
- **Route Parameters**: Pass validated bus number as navigation parameter
- **Back Navigation**: Proper handling of back button to return to HomeScreen
- **Loading States**: Show loading spinner during validation or navigation

### Accessibility Requirements
React Native accessibility standards:
- **Screen Reader Support**: Proper accessibilityLabels for input fields and buttons
- **Touch Targets**: Minimum 44pt touch targets for buttons
- **Keyboard Navigation**: Support for external keyboard navigation
- **High Contrast**: Error messages visible in high contrast modes

### Testing Standards Requirements
[Source: architecture/coding-standards.md]
Testing file locations and patterns:
```
apps/mobile/__tests__/
├── components/
│   └── tracking/
│       └── BusSelector/
│           ├── BusNumberInput.test.tsx
│           ├── RecentBusList.test.tsx
│           └── ValidationError.test.tsx
├── services/
│   ├── storage.test.ts
│   └── validation.test.ts
└── __mocks__/
    └── @react-native-async-storage/async-storage.js
```

**Test Coverage Requirements:**
- Component rendering and user interaction testing
- Validation logic with edge cases (empty input, special characters, out of range)
- AsyncStorage operations (save, retrieve, clear recent numbers)
- Navigation parameter passing
- Error state handling and accessibility

### Performance Considerations
- **Input Debouncing**: Validate input after user stops typing to avoid excessive validation calls
- **AsyncStorage Optimization**: Batch storage operations and handle async operations properly
- **Memory Management**: Proper cleanup of component state on unmount

### Security Considerations
- **Input Sanitization**: Remove special characters and normalize bus number format
- **Data Validation**: Server-side validation backup for all client-side validation
- **Storage Privacy**: No sensitive data stored, only bus numbers for convenience

### Integration Points
Component must work with existing architecture:
- **Navigation**: Use existing React Navigation configuration from Story 1.2
- **State Management**: Integrate with Zustand store from frontend architecture
- **API Integration**: Validated bus numbers will be used in Story 2.2/2.3 for API calls
- **Location Services**: This component precedes location access in the tracker workflow

## Testing

### Testing Standards
[Source: architecture/coding-standards.md]
- **Test File Location**: `apps/mobile/__tests__/components/tracking/BusSelector/`
- **Testing Framework**: Jest with React Native Testing Library
- **Test Patterns**: Component testing with user interaction simulation, service testing with mocked AsyncStorage
- **Coverage Requirements**: Minimum 80% code coverage for validation logic and component interactions
- **Accessibility Testing**: Test screen reader compatibility and keyboard navigation support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive mobile input and validation architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - implementation completed successfully with comprehensive testing.

### Completion Notes List
- Successfully implemented comprehensive BusNumberInput component with proper keyboard optimization and accessibility
- Created complete validation service supporting CVR College bus number formats (numeric 1-50, alphanumeric A1-A20, B1-B20, C1-C10)
- Built AsyncStorage-based storage service for recent bus numbers with privacy controls
- Implemented BusSelector main component orchestrating input, validation, storage, and navigation
- Extended Zustand store with bus selection state management
- Created comprehensive UI components: BusNumberInput, RecentBusList, ValidationError
- Updated shared types with bus validation interfaces and navigation parameters
- Comprehensive test suite: 69 passing tests covering all functionality
- All acceptance criteria met with proper error handling and user experience considerations

### File List
**Core Components:**
- `apps/mobile/src/components/tracking/BusSelector/BusNumberInput.tsx` - Main input component with validation and accessibility
- `apps/mobile/src/components/tracking/BusSelector/RecentBusList.tsx` - Recent bus numbers display with quick selection
- `apps/mobile/src/components/tracking/BusSelector/ValidationError.tsx` - Error message display component
- `apps/mobile/src/components/tracking/BusSelector/index.tsx` - Main BusSelector orchestrating component

**Services:**
- `apps/mobile/src/services/validation.ts` - Bus number validation logic with CVR College formats
- `apps/mobile/src/services/storage.ts` - AsyncStorage service for recent bus numbers persistence

**State Management:**
- `apps/mobile/src/store/appStore.ts` - Updated Zustand store with bus selection state
- `packages/shared-types/src/index.ts` - Added bus validation types and updated navigation types

**Dependencies:**
- `apps/mobile/package.json` - Added @react-native-async-storage/async-storage dependency

**Comprehensive Tests:**
- `apps/mobile/__tests__/services/validation.test.ts` - 19 test cases for bus number validation
- `apps/mobile/__tests__/services/storage.test.ts` - 16 test cases for AsyncStorage operations
- `apps/mobile/__tests__/components/tracking/BusSelector/BusNumberInput.test.tsx` - 14 test cases for input component
- `apps/mobile/__tests__/components/tracking/BusSelector/RecentBusList.test.tsx` - 10 test cases for recent list component
- `apps/mobile/__tests__/components/tracking/BusSelector/ValidationError.test.tsx` - 10 test cases for error display component

## QA Results

### Review Date: 2025-09-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation with comprehensive architecture following React Native best practices. Clean separation of concerns with dedicated components for input, validation, and recent bus management. Strong TypeScript integration with proper interface definitions and shared type usage. Component structure demonstrates solid understanding of React Native accessibility and mobile UX patterns.

### Refactoring Performed

- **File**: `apps/mobile/src/components/tracking/BusSelector/index.tsx`
  - **Change**: Enhanced navigation type safety by removing `as never` casting
  - **Why**: Eliminates TypeScript safety suppression that could lead to runtime navigation errors
  - **How**: Added proper NavigationProp typing with RootStackParamList, enabling compile-time validation of navigation parameters

### Compliance Check

- Coding Standards: ✓ Full compliance with naming conventions and architectural patterns
- Project Structure: ✓ Perfect adherence to established component and service organization
- Testing Strategy: ✓ Comprehensive test coverage with proper React Native Testing Library patterns
- All ACs Met: ✓ All 6 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Enhanced navigation type safety for runtime error prevention (BusSelector/index.tsx)
- [x] Validated comprehensive input sanitization and validation logic (services/validation.ts)
- [x] Confirmed proper AsyncStorage error handling and privacy controls (services/storage.ts)
- [x] Verified accessibility compliance for screen readers and keyboard navigation
- [x] Validated comprehensive test coverage across all components and services (69 passing tests)

### Security Review

**Input Security**: ✓ Comprehensive input sanitization removes special characters and limits length
**Data Storage**: ✓ Only non-sensitive bus numbers stored locally with privacy controls
**Validation**: ✓ Client-side validation with proper error handling, ready for server-side backup validation

### Performance Considerations

**Input Optimization**: ✓ Proper use of useCallback hooks prevents unnecessary re-renders
**Async Operations**: ✓ AsyncStorage operations properly handled with error recovery patterns
**Memory Management**: ✓ Component cleanup and state synchronization properly implemented
**User Experience**: ✓ Loading states and validation debouncing provide smooth interaction flow

### Files Modified During Review

- `apps/mobile/src/components/tracking/BusSelector/index.tsx` - Enhanced navigation type safety

(Note: Dev should update File List to reflect this QA modification)

### Gate Status

Gate: PASS → docs/qa/gates/2.1-bus-number-input-validation.yml
Risk profile: Low-risk implementation with excellent quality standards
NFR assessment: All non-functional requirements exceeded expectations

### Recommended Status

✓ Ready for Done - Implementation exceeds quality standards with comprehensive testing, proper architecture, and full acceptance criteria compliance. The single refactoring improvement has been applied and validated.